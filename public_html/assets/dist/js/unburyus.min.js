/*
 unbury.us 2014-04-10 
*/
function Loan(a,b,c,d,e){this.id=a,this.loanName=b,this.currentBalance=c,this.minimumPayment=d,this.interestRate=e}function respChart(a,b,c,d,e){function f(){a.attr("width",$(i).width()),a.attr("height",400);new Chart(h).Line(b,c)}console.log(d),console.log(e);var g={scaleOverlay:!1,scaleOverride:!0,scaleSteps:d,scaleStepWidth:e,scaleStartValue:0,scaleLineColor:"rgba(0,0,0,.1)",scaleLineWidth:1,scaleShowLabels:!0,scaleLabel:"<%=value%>",scaleFontFamily:"'HelveticaNeue-Light','Helvetica Neue','proxima-nova'",scaleFontSize:12,scaleFontStyle:"normal",scaleFontColor:"#909090",scaleShowGridLines:!0,scaleGridLineColor:"rgba(0,0,0,.05)",scaleGridLineWidth:1,bezierCurve:!1,pointDot:!0,pointDotRadius:3,pointDotStrokeWidth:1,datasetStroke:!0,datasetStrokeWidth:2,datasetFill:!0,animation:!0,animationSteps:60,animationEasing:"easeOutQuart",onAnimationComplete:null};(0==c||null==c)&&(c=g);var h=a.get(0).getContext("2d"),i=$(a).parent();$(window).resize(f),f()}function Router(){}var ApplicationController=function(){};ApplicationController.changePaymentType=function(a){var b=$(a);"avalanche-btn"==b.attr("id")?b.hasClass("btn-default")&&(b.removeClass("btn-default").addClass("btn-primary"),$("#snowball-btn").removeClass("btn-primary").addClass("btn-default"),window.payment_type="avalanche"):b.hasClass("btn-default")&&(b.removeClass("btn-default").addClass("btn-primary"),$("#avalanche-btn").removeClass("btn-primary").addClass("btn-default"),window.payment_type="snowball")},ApplicationController.monthly_payment_input_change=function(){var a=$("#monthly-payment"),b=a.val(),c=0;for(key in window.loans)c+=window.loans[key].minimumPayment;$.isNumeric(b)&&Number(b)>=c?window.monthly_payment=Number(b):(window.monthly_payment=c,a.val(c))},ApplicationController.calculate=function(){if(console.log(Object.size(window.loans)),0==Object.size(window.loans))alert("Add a loan!");else if(LoanController.valid())alert("One of your loans are invalid!");else{var a=ResultsController.results();GraphController.graph(a)}},Object.size=function(a){var b,c=0;for(b in a)a.hasOwnProperty(b)&&c++;return c},UDate=function(){this.year=0,this.month=0,this.setCurrent()},UDate.prototype.setCurrent=function(){var a=new Date;this.year=a.getFullYear(),this.month=a.getMonth()},UDate.prototype.setDate=function(a,b){this.year=a,this.month=b},UDate.prototype.getMonth=function(){return this.month},UDate.prototype.getYear=function(){return this.year},UDate.prototype.getFloat=function(){return parseFloat(this.year+.01*this.month)},UDate.prototype.getLatest=function(a){var b=new Unburyme.Date;return this.getYear()>a.getYear()?b.setDate(this.getYear(),this.getMonth()):this.getYear()<a.getYear()?b.setDate(a.getYear(),a.getMonth()):this.getMonth()>a.getMonth()?b.setDate(this.getYear(),this.getMonth()):this.getMonth()<a.getMonth()?b.setDate(a.getYear(),a.getMonth()):b.setDate(this.getYear(),this.getMonth()),b},UDate.prototype.increment=function(){11==this.month?(this.year++,this.month=0):this.month++},UDate.prototype.decrement=function(){0==this.month?(this.year--,this.month=11):this.month--},UDate.prototype.print=function(){var a=["January","February","March","April","May","June","July","August","September","October","November","December"];return a[this.month]+" "+this.year},function(a,b,c,d,e,f,g){a.GoogleAnalyticsObject=e,a[e]=a[e]||function(){(a[e].q=a[e].q||[]).push(arguments)},a[e].l=1*new Date,f=b.createElement(c),g=b.getElementsByTagName(c)[0],f.async=1,f.src=d,g.parentNode.insertBefore(f,g)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-49140200-1","unbury.us"),ga("send","pageview");var GraphController=function(){};GraphController.graph=function(a){var b=GraphController.get_data(a),c=$("#graph");if(!$("#myChart").length){var d="<h4 class='text-center'>Principal Remaining</h4>",e='<canvas id="myChart"  height="400"></canvas>';c.append(d+e)}var f=GraphController.get_steps();respChart($("#myChart"),b,!1,f,GraphController.get_step_width(a,f))},GraphController.get_steps=function(){return 20},GraphController.get_step_width=function(a,b){for(var c=0,d=0;d<a.loans.length;d++)for(var e=0;e<a.loans[d].rows.length;e++)c<parseFloat(a.loans[d].rows[e].principal_remaining)&&(c=parseFloat(a.loans[d].rows[e].principal_remaining));return Math.round(c/b)},GraphController.get_data=function(a){var b=0,c=0,d=[];a.loans.sort(function(a,b){return b.currentBalance-a.currentBalance});for(var e=0;e<a.loans.length;e++){a.loans[e].rows.length>b&&(b=a.loans[e].rows.length,c=e),d[e]=GraphController.get_color_hash(e),d[e].data=[];for(var f=0;f<a.loans[e].rows.length;f++)d[e].data.push(a.loans[e].rows[f].principal_remaining)}for(var g=[],e=0;e<a.loans[c].rows.length;e++)g.push(a.loans[c].rows[e].date);console.log(d);var h={labels:g,datasets:d};return h},GraphController.get_color_hash=function(a){var b={};switch(a%5){case 0:b={fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff"};break;case 1:b={fillColor:"rgba(200,0,0,0.5)",strokeColor:"rgba(200,0,0,1)",pointColor:"rgba(200,0,0,1)",pointStrokeColor:"#fff"};break;case 2:b={fillColor:"rgba(50,50,50,0.5)",strokeColor:"rgba(50,50,50,1)",pointColor:"rgba(50,50,50,1)",pointStrokeColor:"#fff"};break;case 3:b={fillColor:"rgba(0,200,0,0.5)",strokeColor:"rgba(0,200,0,1)",pointColor:"rgba(0,200,0,1)",pointStrokeColor:"#fff"};break;case 4:b={fillColor:"rgba(0,0,200,0.5)",strokeColor:"rgba(0,0,200,1)",pointColor:"rgba(0,0,200,1)",pointStrokeColor:"#fff"}}return b},$().ready(function(){window.loans={},window.auto_increment=-1,window.monthly_payment=0,ApplicationController.monthly_payment_input_change(),window.payment_type="avalanche",Router.init(),LoanController.add_loan(),Router.add_monthly_payment_listener(),Router.add_calculate_listener(),Handlebars.registerPartial("row",$("#loan-table-row-partial").html())}),Loan.prototype.set_loan_field=function(a,b){switch(a){case"loan-name":this.loanName=b;break;case"current-balance":this.currentBalance=Number(b);break;case"minimum-payment":this.minimumPayment=Number(b);break;case"interest-rate":this.interestRate=Number(b)}ApplicationController.monthly_payment_input_change()},Loan.prototype.validate_field=function(a,b){switch(a){case"loan-name":return b.length;case"current-balance":case"minimum-payment":case"interest-rate":return $.isNumeric(b)&&Number(b)>0}};var LoanController=function(){};LoanController.add_loan=function(){window.auto_increment+=1;var a=window.auto_increment,b=$("#loan-input-template").html(),c=Handlebars.compile(b),d={id:a},e=c(d);$("#loan-inputs").append(e),$("#loan"+a).hide().fadeIn("500"),window.loans[a]=new Loan(a,0,0,0,0),Router.add_loan_destroy_listener(a),Router.add_loan_input_listeners(a)},LoanController.remove_loan=function(a){var b=$("#loan"+a);b.next().remove(),b.animate({height:0,opacity:0},"slow",function(){$(this).remove()}),delete window.loans[a]},LoanController.loan_input_change=function(a,b,c){var d=$(c).val(),e=window.loans[a];Loan.prototype.validate_field(b,d)?($(c).removeClass("input-error").addClass("input-success"),e.set_loan_field(b,d)):$(c).removeClass("input-success").addClass("input-error")},LoanController.valid=function(){return $(".input-error").length};var ResultsController=function(){};ResultsController.results=function(){var a=ResultsController.compute_results();return null==a?alert("You will never pay off this loan! Please try again!"):(ResultsController.draw_total_results(a),ResultsController.draw_loan_results(a)),a},ResultsController.draw_total_results=function(a){var b=$("#total-results-template").html(),c=Handlebars.compile(b),d=c(a);$("#total-results").empty().append(d),$("#total-results").hide().fadeIn("500")},ResultsController.draw_loan_results=function(a){var b=$("#loan-results-template").html(),c=Handlebars.compile(b),d=c(a);$("#loan-results").empty().append(d),$("#loan-results").hide().fadeIn("500");for(var e=0;e<a.loans.length;e++)Router.add_loan_table_result_listener(a.loans[e].id)},ResultsController.compute_results=function(){var a=window.loans,b=[];for(var c in a)b.push(a[c]);return b.sort("avalanche"==window.payment_type?function(a,b){return b.interestRate-a.interestRate}:function(a,b){return a.currentBalance-b.currentBalance}),ResultsController.calculate(b)},ResultsController.calculate=function(a){for(var b=new UDate,c=[],d=[],e=[],f=[],g=[],h=[],i=[],j=a.length,k=a.length,l=!0,m=0;k>m;m++)a[m].total_interest_paid=0,a[m].rows=[],c[m]=a[m].currentBalance,d[m]=.01*a[m].interestRate,e[m]=a[m].minimumPayment,i[m]=0;for(;0!=j&&l;){for(var n=window.monthly_payment,o=!0,p=0;k>p;p++)0==i[p]&&(f[p]=c[p]*(d[p]/12),g[p]=0,a[p].total_interest_paid+=f[p],h[p]=e[p],n-=e[p]);for(;(n>0||o)&&j;){for(var q=0;k>q;q++)n>0&&c[q]>0&&(h[q]+=n,n=0);for(var r=0;k>r;r++)c[r]>0&&(h[r]-f[r]<c[r]?(g[r]=h[r]-f[r],c[r]-=g[r]):(g[r]=c[r],n=h[r]-c[r]-f[r],h[r]=c[r]+f[r],c[r]=0,j-=1,a[r].rows.push({principal_remaining:c[r].toFixed(2),principal_paid:g[r].toFixed(2),balance:c[r].toFixed(2),payment:Number(h[r]).toFixed(2),interest_paid:f[r].toFixed(2),date:b.print()}))),c[r]>0&&a[r].rows.push({principal_remaining:c[r].toFixed(2),principal_paid:g[r].toFixed(2),balance:c[r].toFixed(2),payment:Number(h[r]).toFixed(2),interest_paid:f[r].toFixed(2),date:b.print()});o=!1}for(var s=0;k>s;s++)0==i[s]&&0==c[s]&&(i[s]=1,a[s].date=jQuery.extend(!0,{},b).print());b.increment(),b.getYear()>2200&&(console.log("hit"),l=!1)}if(l){for(var t=0,u=0;k>u;u++)t+=a[u].total_interest_paid,a[u].total_interest_paid=a[u].total_interest_paid.toFixed(2);return b.decrement(),{loans:a,total_interest:t.toFixed(2),year:b.print()}}return console.log("impossible"),null},Router.init=function(){$("#add-loan").click(function(){LoanController.add_loan()}),$("#avalanche-btn").click(function(){ApplicationController.changePaymentType(this)}),$("#snowball-btn").click(function(){ApplicationController.changePaymentType(this)})},Router.add_monthly_payment_listener=function(){$("#monthly-payment").focusout(function(){ApplicationController.monthly_payment_input_change()})},Router.add_loan_destroy_listener=function(a){$("#destroy-button-"+a).click(function(){LoanController.remove_loan(a)})},Router.add_loan_input_listeners=function(a){Router.add_loan_input_listener(a,"loan-name"),Router.add_loan_input_listener(a,"current-balance"),Router.add_loan_input_listener(a,"minimum-payment"),Router.add_loan_input_listener(a,"interest-rate")},Router.add_loan_input_listener=function(a,b){$("#loan"+a).find("input[name="+b+"]").focusout(function(){LoanController.loan_input_change(a,b,this),ApplicationController.monthly_payment_input_change()})},Router.add_calculate_listener=function(){$("#calculate").click(function(){ApplicationController.calculate()})},Router.add_loan_table_result_listener=function(a){$("#loan-head-"+a).click(function(){$(this).next().next().toggle()})};